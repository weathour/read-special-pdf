

<!-- templates/index.html -->
{% extends "base.html" %}

{% block title %}PDFå¤„ç†å™¨ - ä¸»é¡µ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- è¾“å…¥æºé€‰æ‹© -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-folder-open"></i> é€‰æ‹©è¾“å…¥æº</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="folder-section" id="folderSection">
                            <h6><i class="fas fa-folder"></i> é€‰æ‹©æ–‡ä»¶å¤¹</h6>
                            <div class="mb-3">
                                <label for="folderPath" class="form-label">æ–‡ä»¶å¤¹è·¯å¾„</label>
                                <input type="text" class="form-control path-input" id="folderPath" 
                                       placeholder="ä¾‹å¦‚: C:\Documents\PDFs æˆ– /home/user/documents">
                            </div>
                            <button class="btn btn-primary" id="scanFolder">
                                <i class="fas fa-search"></i> æ‰«ææ–‡ä»¶å¤¹
                            </button>
                            <div id="folderFileList" class="mt-3" style="display: none;">
                                <h6>æ‰¾åˆ°çš„PDFæ–‡ä»¶:</h6>
                                <div class="file-list" id="folderFileItems"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="folder-section" id="uploadSection">
                            <h6><i class="fas fa-upload"></i> ä¸Šä¼ æ–‡ä»¶</h6>
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                <p>æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
                                <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
                                <button class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open"></i> é€‰æ‹©æ–‡ä»¶
                                </button>
                            </div>
                            <div id="uploadFileList" class="mt-3" style="display: none;">
                                <h6>å·²é€‰æ‹©çš„æ–‡ä»¶:</h6>
                                <div class="file-list" id="uploadFileItems"></div>
                            </div>
                            <button class="btn btn-warning mt-2" id="uploadFiles" disabled>
                                <i class="fas fa-upload"></i> ä¸Šä¼ æ–‡ä»¶
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¾“å‡ºè®¾ç½® -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-folder-plus"></i> è¾“å‡ºè®¾ç½®</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="outputPath" class="form-label">è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" class="form-control path-input" id="outputPath" 
                                   placeholder="ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„ï¼ˆè‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å¤¹ï¼‰">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="forceReprocess">
                                <label class="form-check-label" for="forceReprocess">
                                    å¼ºåˆ¶é‡æ–°å¤„ç†
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="card mt-4">
            <div class="card-body">
                <div class="d-flex gap-2">
                    <button class="btn btn-success" id="startProcessing" disabled>
                        <i class="fas fa-play"></i> å¼€å§‹å¤„ç†
                    </button>
                    <button class="btn btn-danger stop-btn" id="stopProcessing" style="display: none;">
                        <i class="fas fa-stop"></i> åœæ­¢å¤„ç†
                    </button>
                </div>
            </div>
        </div>
        
        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="card mt-4" id="progressCard" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-tasks"></i> å¤„ç†è¿›åº¦</h5>
                <div class="timer-display" id="timerDisplay">00:00:00</div>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%">
                        <span id="progressText">0%</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>å½“å‰æ–‡ä»¶:</strong> <span id="currentFile">-</span></p>
                        <p><strong>çŠ¶æ€:</strong> <span id="statusMessage">-</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>å·²å¤„ç†:</strong> <span id="processedCount">0</span></p>
                        <p><strong>å¤±è´¥:</strong> <span id="failedCount">0</span></p>
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="downloadResults" style="display: none;">
                        <i class="fas fa-download"></i> ä¸‹è½½ç»“æœ
                    </button>
                    <button class="btn btn-info" id="openOutputFolder" style="display: none;">
                        <i class="fas fa-folder-open"></i> æ‰“å¼€è¾“å‡ºæ–‡ä»¶å¤¹
                    </button>
                </div>
            </div>
        </div>
        
        <!-- å¤„ç†æ—¥å¿— -->
        <div class="card mt-4" id="logCard" style="display: none;">
            <div class="card-header">
                <h5><i class="fas fa-terminal"></i> å¤„ç†æ—¥å¿—</h5>
            </div>
            <div class="card-body">
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜</h5>
            </div>
            <div class="card-body">
                <h6>æ–¹å¼1: é€‰æ‹©æ–‡ä»¶å¤¹</h6>
                <ol>
                    <li>è¾“å…¥åŒ…å«PDFæ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„</li>
                    <li>ç‚¹å‡»"æ‰«ææ–‡ä»¶å¤¹"æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨</li>
                    <li>è®¾ç½®è¾“å‡ºæ–‡ä»¶å¤¹ï¼ˆå¯é€‰ï¼‰</li>
                    <li>ç‚¹å‡»"å¼€å§‹å¤„ç†"</li>
                </ol>
                
                <h6>æ–¹å¼2: ä¸Šä¼ æ–‡ä»¶</h6>
                <ol>
                    <li>æ‹–æ‹½æˆ–é€‰æ‹©PDFæ–‡ä»¶</li>
                    <li>ç‚¹å‡»"ä¸Šä¼ æ–‡ä»¶"</li>
                    <li>è®¾ç½®è¾“å‡ºæ–‡ä»¶å¤¹ï¼ˆå¯é€‰ï¼‰</li>
                    <li>ç‚¹å‡»"å¼€å§‹å¤„ç†"</li>
                </ol>
                
                <h6 class="mt-3">æ–°åŠŸèƒ½:</h6>
                <ul>
                    <li><strong>è®¡æ—¶å™¨:</strong> æ˜¾ç¤ºå¤„ç†è€—æ—¶</li>
                    <li><strong>åœæ­¢æŒ‰é’®:</strong> å¯ä¸­æ–­å¤„ç†</li>
                    <li><strong>æŒ‡å®šè¾“å‡º:</strong> è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„</li>
                    <li><strong>æ–‡ä»¶å¤¹æ‰«æ:</strong> æ‰¹é‡å¤„ç†æ•´ä¸ªæ–‡ä»¶å¤¹</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-tools"></i> å¿«é€Ÿæ“ä½œ</h5>
            </div>
            <div class="card-body">
                <div class="btn-group-vertical w-100">
                    <a href="{{ url_for('config_page') }}" class="btn btn-outline-primary">
                        <i class="fas fa-cog"></i> ä¿®æ”¹é…ç½®
                    </a>
                    <a href="{{ url_for('history') }}" class="btn btn-outline-info">
                        <i class="fas fa-history"></i> æŸ¥çœ‹å†å²
                    </a>
                    <a href="{{ url_for('cleanup') }}" class="btn btn-outline-warning">
                        <i class="fas fa-trash"></i> æ¸…ç†æ–‡ä»¶
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-keyboard"></i> è·¯å¾„æ ¼å¼</h5>
            </div>
            <div class="card-body">
                <h6>Windows:</h6>
                <code>C:\Users\ç”¨æˆ·å\Documents\PDFs</code>
                
                <h6>Linux/Mac:</h6>
                <code>/home/ç”¨æˆ·å/documents/pdfs</code>
                
                <h6>ç›¸å¯¹è·¯å¾„:</h6>
                <code>./pdfs</code> æˆ– <code>../documents</code>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedFiles = [];
let currentUploadFolder = null;
let currentOutputFolder = null;
let statusCheckInterval = null;
let timerInterval = null;
let startTime = null;
let useScannedFolder = false;

$(document).ready(function() {
    // æ–‡ä»¶é€‰æ‹©å¤„ç†
    $('#fileInput').on('change', function(e) {
        handleFileSelect(e.target.files);
        selectInputMethod('upload');
    });
    
    // æ‹–æ‹½ä¸Šä¼ 
    $('#uploadArea').on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    $('#uploadArea').on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });
    
    $('#uploadArea').on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        handleFileSelect(e.originalEvent.dataTransfer.files);
        selectInputMethod('upload');
    });
    
    // æŒ‰é’®äº‹ä»¶
    $('#scanFolder').on('click', scanFolder);
    $('#uploadFiles').on('click', uploadFiles);
    $('#startProcessing').on('click', startProcessing);
    $('#stopProcessing').on('click', stopProcessing);
    $('#downloadResults').on('click', downloadResults);
    $('#openOutputFolder').on('click', openOutputFolder);
    
    // æ–‡ä»¶å¤¹è·¯å¾„è¾“å…¥æ¡†å›è½¦äº‹ä»¶
    $('#folderPath').on('keypress', function(e) {
        if (e.which === 13) {
            scanFolder();
        }
    });
});

function selectInputMethod(method) {
    if (method === 'folder') {
        $('#folderSection').addClass('active');
        $('#uploadSection').removeClass('active');
        useScannedFolder = true;
    } else {
        $('#uploadSection').addClass('active');
        $('#folderSection').removeClass('active');
        useScannedFolder = false;
    }
    updateStartButton();
}

function scanFolder() {
    const folderPath = $('#folderPath').val().trim();
    if (!folderPath) {
        alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„');
        return;
    }
    
    $('#scanFolder').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> æ‰«æä¸­...');
    
    $.ajax({
        url: '/scan_folder',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ folder_path: folderPath }),
        success: function(response) {
            if (response.success) {
                displayFolderFiles(response.files, response.processing_summary);
                selectInputMethod('folder');
                
                // æ˜¾ç¤ºè¯¦ç»†çš„æ‰«æç»“æœ
                const summary = response.processing_summary;
                const detailMessage = `æ‰«æå®Œæˆï¼\n\n` +
                    `ğŸ“ æ€»æ–‡ä»¶æ•°: ${summary.total_files}\n` +
                    `âœ… å·²å¤„ç†: ${summary.processed_files}\n` +
                    `ğŸ†• æ–°æ–‡ä»¶: ${summary.new_files}\n` +
                    `ğŸ”„ é…ç½®æ›´æ”¹éœ€é‡å¤„ç†: ${summary.config_changed_files}\n` +
                    `ğŸ“ éœ€è¦å¤„ç†: ${summary.need_process_files}\n\n` +
                    `${summary.need_process_files === 0 ? 'æ‰€æœ‰æ–‡ä»¶éƒ½å·²å¤„ç†å®Œæˆï¼' : `å°†å¤„ç† ${summary.need_process_files} ä¸ªæ–‡ä»¶`}`;
                
                alert(detailMessage);
            } else {
                alert('æ‰«æå¤±è´¥: ' + response.message);
            }
        },
        error: function() {
            alert('æ‰«æå¤±è´¥ï¼Œè¯·é‡è¯•');
        },
        complete: function() {
            $('#scanFolder').prop('disabled', false).html('<i class="fas fa-search"></i> æ‰«ææ–‡ä»¶å¤¹');
        }
    });
}

function displayFolderFiles(files, summary) {
    const fileItems = $('#folderFileItems');
    fileItems.empty();
    
    // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
    const summaryHtml = `
        <div class="alert alert-info mb-3">
            <h6><i class="fas fa-chart-pie"></i> æ‰«æç»Ÿè®¡</h6>
            <div class="row">
                <div class="col-6">
                    <small><strong>æ€»æ–‡ä»¶:</strong> ${summary.total_files}</small><br>
                    <small><strong>å·²å¤„ç†:</strong> <span class="text-success">${summary.processed_files}</span></small><br>
                </div>
                <div class="col-6">
                    <small><strong>æ–°æ–‡ä»¶:</strong> <span class="text-primary">${summary.new_files}</span></small><br>
                    <small><strong>éœ€é‡å¤„ç†:</strong> <span class="text-warning">${summary.config_changed_files}</span></small><br>
                </div>
            </div>
        </div>
    `;
    fileItems.append(summaryHtml);
    
    // æŒ‰çŠ¶æ€åˆ†ç»„æ˜¾ç¤ºæ–‡ä»¶
    const statusGroups = {
        'new': { title: 'ğŸ†• æ–°æ–‡ä»¶', files: [], class: 'text-primary' },
        'config_changed': { title: 'ğŸ”„ éœ€é‡å¤„ç†', files: [], class: 'text-warning' },
        'output_missing': { title: 'ğŸ“ è¾“å‡ºä¸¢å¤±', files: [], class: 'text-warning' },
        'processed': { title: 'âœ… å·²å¤„ç†', files: [], class: 'text-success' }
    };
    
    files.forEach(file => {
        if (statusGroups[file.status]) {
            statusGroups[file.status].files.push(file);
        }
    });
    
    // æ˜¾ç¤ºå„çŠ¶æ€ç»„çš„æ–‡ä»¶
    Object.entries(statusGroups).forEach(([status, group]) => {
        if (group.files.length > 0) {
            fileItems.append(`<h6 class="mt-3 ${group.class}">${group.title} (${group.files.length})</h6>`);
            
            group.files.forEach(file => {
                const fileItem = `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                        <div>
                            <i class="fas fa-file-pdf text-danger"></i>
                            <small><strong>${file.name}</strong></small>
                            ${file.parent_dir !== 'æ ¹ç›®å½•' ? `<br><small class="text-muted ms-3">${file.parent_dir}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="text-muted">${file.size_mb} MB</span><br>
                            <small class="badge bg-secondary">${file.status_text}</small>
                        </div>
                    </div>
                `;
                fileItems.append(fileItem);
            });
        }
    });
    
    $('#folderFileList').show();
    updateStartButton();
}

function handleFileSelect(files) {
    selectedFiles = Array.from(files).filter(file => file.type === 'application/pdf');
    
    if (selectedFiles.length === 0) {
        alert('è¯·é€‰æ‹©PDFæ–‡ä»¶');
        return;
    }
    
    displaySelectedFiles();
    $('#uploadFiles').prop('disabled', false);
}

function displaySelectedFiles() {
    const fileItems = $('#uploadFileItems');
    fileItems.empty();
    
    selectedFiles.forEach(file => {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        const fileItem = `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div>
                    <i class="fas fa-file-pdf text-danger"></i>
                    <strong>${file.name}</strong>
                </div>
                <span class="text-muted">${fileSize} MB</span>
            </div>
        `;
        fileItems.append(fileItem);
    });
    
    $('#uploadFileList').show();
}

function uploadFiles() {
    if (selectedFiles.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
    }
    
    const formData = new FormData();
    selectedFiles.forEach(file => {
        formData.append('files', file);
    });
    
    $('#uploadFiles').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> ä¸Šä¼ ä¸­...');
    
    $.ajax({
        url: '/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                alert(response.message);
                currentUploadFolder = response.upload_folder;
                updateStartButton();
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + response.message);
            }
        },
        error: function() {
            alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
        },
        complete: function() {
            $('#uploadFiles').prop('disabled', false).html('<i class="fas fa-upload"></i> ä¸Šä¼ æ–‡ä»¶');
        }
    });
}

function updateStartButton() {
    const canStart = useScannedFolder ? $('#folderFileList').is(':visible') : currentUploadFolder;
    $('#startProcessing').prop('disabled', !canStart);
}

function startProcessing() {
    const data = {
        input_folder: $('#folderPath').val().trim(),
        output_folder: $('#outputPath').val().trim(),
        force_reprocess: $('#forceReprocess').is(':checked'),
        use_scanned_folder: useScannedFolder
    };
    
    $.ajax({
        url: '/process',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                currentOutputFolder = response.output_folder;
                $('#progressCard').show();
                $('#logCard').show();
                $('#startProcessing').prop('disabled', true);
                $('#stopProcessing').show();
                startTime = Date.now();
                startStatusCheck();
                startTimer();
            } else {
                alert('å¤„ç†å¯åŠ¨å¤±è´¥: ' + response.message);
            }
        },
        error: function() {
            alert('å¤„ç†å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
}

function stopProcessing() {
    if (confirm('ç¡®å®šè¦åœæ­¢å¤„ç†å—ï¼Ÿ')) {
        $.ajax({
            url: '/stop_processing',
            type: 'POST',
            success: function(response) {
                if (response.success) {
                    $('#stopProcessing').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> åœæ­¢ä¸­...');
                } else {
                    alert('åœæ­¢å¤±è´¥: ' + response.message);
                }
            },
            error: function() {
                alert('åœæ­¢å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });
    }
}

function startStatusCheck() {
    statusCheckInterval = setInterval(updateStatus, 1000);
}

function startTimer() {
    timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    if (startTime) {
        const elapsed = Date.now() - startTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        const timerText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        $('#timerDisplay').text(timerText);
    }
}

function updateStatus() {
    $.ajax({
        url: '/status',
        type: 'GET',
        success: function(status) {
            updateProgressDisplay(status);
            updateLogDisplay(status);
            
            if (!status.is_processing) {
                clearInterval(statusCheckInterval);
                clearInterval(timerInterval);
                $('#startProcessing').prop('disabled', false);
                $('#stopProcessing').hide().prop('disabled', false).html('<i class="fas fa-stop"></i> åœæ­¢å¤„ç†');
                
                if (status.processed_files > 0) {
                    $('#downloadResults').show();
                    $('#openOutputFolder').show();
                }
            }
        }
    });
}

function updateProgressDisplay(status) {
    const progress = status.progress || 0;
    $('#progressBar').css('width', progress + '%');
    $('#progressText').text(progress + '%');
    $('#currentFile').text(status.current_file || '-');
    $('#statusMessage').text(status.message || '-');
    $('#processedCount').text(status.processed_files || 0);
    $('#failedCount').text(status.failed_files || 0);
    
    // æ·»åŠ è·³è¿‡æ–‡ä»¶æ•°æ˜¾ç¤º
    if (status.skipped_files > 0) {
        if ($('#skippedCount').length === 0) {
            $('#failedCount').parent().after('<p><strong>è·³è¿‡:</strong> <span id="skippedCount">0</span></p>');
        }
        $('#skippedCount').text(status.skipped_files);
    }
}

function updateLogDisplay(status) {
    const logContainer = $('#logContainer');
    logContainer.empty();
    
    if (status.logs && status.logs.length > 0) {
        status.logs.forEach(log => {
            const logEntry = `
                <div class="log-entry">
                    <span class="text-muted">[${log.timestamp}]</span>
                    <span>${log.message}</span>
                </div>
            `;
            logContainer.append(logEntry);
        });
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        logContainer.scrollTop(logContainer[0].scrollHeight);
    }
}

function downloadResults() {
    window.location.href = '/download_results';
}

function openOutputFolder() {
    $.ajax({
        url: '/open_output_folder',
        type: 'POST',
        success: function(response) {
            if (response.success) {
                alert(response.message);
            } else {
                alert('æ‰“å¼€å¤±è´¥: ' + response.message);
            }
        },
        error: function() {
            alert('æ‰“å¼€å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
}
</script>
{% endblock %}
